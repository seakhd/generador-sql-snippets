<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Snippets SQL Server</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .code-block { font-family: 'Roboto Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .form-input, .form-select, .form-textarea {
            background-color: #374151; border: 1px solid #4b5563; border-radius: 0.5rem;
            padding: 0.75rem; width: 100%; color: #e5e7eb; transition: all 0.2s ease-in-out;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none; box-shadow: 0 0 0 2px #2563eb; border-color: #2563eb;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Generador de Snippets SQL</h1>
            <p class="text-gray-400 mt-2">Pega tu script SQL para convertirlo en un fichero <span class="font-mono bg-gray-700 px-2 py-1 rounded">.snippet</span>.</p>
        </div>

        <!-- Step 1: Metadata -->
        <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-semibold text-gray-300 mb-4">1. Metadatos del Snippet</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="snippet-title" class="block text-sm font-medium text-gray-400 mb-1">Título</label>
                    <input type="text" id="snippet-title" class="form-input" placeholder="Ej: Insertar nuevo paciente">
                </div>
                <div>
                    <label for="snippet-shortcut" class="block text-sm font-medium text-gray-400 mb-1">Atajo (Shortcut)</label>
                    <input type="text" id="snippet-shortcut" class="form-input" placeholder="Ej: inspac">
                </div>
                <div class="md:col-span-2">
                    <label for="snippet-description" class="block text-sm font-medium text-gray-400 mb-1">Descripción</label>
                    <input type="text" id="snippet-description" class="form-input" placeholder="Ej: Snippet para un nuevo registro en la tabla Pacientes">
                </div>
                <div>
                    <label for="snippet-author" class="block text-sm font-medium text-gray-400 mb-1">Autor</label>
                    <input type="text" id="snippet-author" class="form-input" placeholder="Tu nombre o alias">
                </div>
                <div>
                    <label for="snippet-type" class="block text-sm font-medium text-gray-400 mb-1">Tipo de Snippet</label>
                    <select id="snippet-type" class="form-select">
                        <option>Expansion</option>
                        <option>SurroundsWith</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Step 2: Snippet Content -->
         <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-semibold text-gray-300 mb-4">2. Script SQL</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label for="plain-text-input" class="block text-sm font-medium text-gray-400">Pega aquí tu script final:</label>
                    <textarea id="plain-text-input" rows="8" class="form-textarea h-full code-block" placeholder="SELECT * FROM dbo.Pac_Paciente WHERE FechaAlta > '2023-01-01';"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-400">O sube un archivo .SQL:</label>
                    <div id="file-drop-area" class="flex flex-col items-center justify-center w-full h-full border-2 border-dashed border-gray-600 rounded-lg p-4 cursor-pointer hover:bg-gray-700/50 hover:border-cyan-500 transition">
                        <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <p id="file-info" class="mb-2 text-sm text-gray-400 text-center"><span class="font-semibold">Haz clic para subir</span> o arrastra</p>
                        <input type="file" id="sql-file-input" class="hidden" accept=".sql">
                    </div>
                     <button id="clear-file-btn" class="hidden w-full mt-2 text-sm text-red-400 hover:text-red-300">Quitar archivo</button>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center pt-4">
            <button id="generate-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center mx-auto">
                Crear Snippet
            </button>
        </div>

        <!-- Output Section -->
        <div id="output-container" class="hidden space-y-4 pt-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h2 class="text-xl font-semibold text-gray-300">3. Resultado (.snippet XML)</h2>
                <div class="flex gap-2">
                    <button id="copy-btn" class="bg-gray-600 hover:bg-gray-500 text-gray-200 font-semibold py-2 px-4 rounded-lg flex items-center">
                        Copiar
                    </button>
                    <button id="download-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Descargar Fichero
                    </button>
                </div>
            </div>
            <pre class="p-4 overflow-x-auto bg-gray-900 rounded-lg border border-gray-700"><code id="sql-output" class="code-block text-cyan-300"></code></pre>
            <div id="feedback" class="text-center font-medium h-4"></div>
        </div>
    </div>

    <script>
        // DOM Elements
        const plainTextInput = document.getElementById('plain-text-input');
        const sqlFileInput = document.getElementById('sql-file-input');
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInfo = document.getElementById('file-info');
        const clearFileBtn = document.getElementById('clear-file-btn');
        const generateBtn = document.getElementById('generate-btn');
        const outputContainer = document.getElementById('output-container');
        const sqlOutput = document.getElementById('sql-output');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');
        const feedback = document.getElementById('feedback');
        
        // Metadata inputs
        const snippetTitle = document.getElementById('snippet-title');
        const snippetShortcut = document.getElementById('snippet-shortcut');
        const snippetDescription = document.getElementById('snippet-description');
        const snippetAuthor = document.getElementById('snippet-author');
        const snippetType = document.getElementById('snippet-type');

        let fileContent = null;
        let fileName = '';

        // --- File Handling ---
        fileDropArea.addEventListener('click', () => sqlFileInput.click());
        sqlFileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { fileDropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false); });
        ['dragenter', 'dragover'].forEach(eventName => { fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('bg-gray-700/50', 'border-cyan-500'), false); });
        ['dragleave', 'drop'].forEach(eventName => { fileDropArea.addEventListener(eventName, () => fileDropArea.classList.remove('bg-gray-700/50', 'border-cyan-500'), false); });
        fileDropArea.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.sql')) { handleFile(file); } 
            else { alert('Por favor, sube solo archivos .sql'); }
        });

        function handleFile(file) {
            fileName = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                fileContent = e.target.result;
                fileInfo.textContent = `Archivo: ${fileName}`;
                fileInfo.classList.add('text-cyan-400', 'font-bold');
                clearFileBtn.classList.remove('hidden');
                plainTextInput.disabled = true;
                plainTextInput.value = '';
                plainTextInput.placeholder = 'La entrada de texto está deshabilitada.';
            };
            reader.readAsText(file);
        }
        
        clearFileBtn.addEventListener('click', () => {
            fileContent = null; fileName = ''; sqlFileInput.value = '';
            fileInfo.innerHTML = `<span class="font-semibold">Haz clic para subir</span> o arrastra`;
            fileInfo.classList.remove('text-cyan-400', 'font-bold');
            clearFileBtn.classList.add('hidden');
            plainTextInput.disabled = false;
            plainTextInput.placeholder = "SELECT * FROM dbo.Pac_Paciente WHERE FechaAlta > '2023-01-01';";
        });

        // --- LÓGICA DE CREACIÓN DIRECTA ---
        generateBtn.addEventListener('click', () => {
            const userInput = fileContent || plainTextInput.value.trim();

            if (!userInput) {
                alert('Por favor, escribe o sube un script SQL.');
                return;
            }
            if (!snippetTitle.value) {
                alert('Por favor, introduce un título para el snippet.');
                snippetTitle.focus();
                return;
            }
            
            try {
                const metadata = {
                    title: snippetTitle.value, shortcut: snippetShortcut.value, description: snippetDescription.value,
                    author: snippetAuthor.value, snippetType: snippetType.value
                };
                
                const xmlSnippet = createSnippetXML(metadata, userInput);
                displayResult(xmlSnippet);
                showFeedback('¡Snippet XML creado con éxito!', 'success');

            } catch (error) {
                console.error('Error al crear el snippet:', error);
                displayResult(`<!-- Ocurrió un error: ${error.message} -->`);
                showFeedback(`Error: ${error.message}`, 'error');
            }
        });
        
        function createSnippetXML(metadata, sqlCode) {
            const safeSqlCode = sqlCode.replace(/]]>/g, ']]]]><![CDATA[>');
            return `<?xml version="1.0" encoding="utf-8" ?>
<CodeSnippets xmlns="http://schemas.microsoft.com/VisualStudio/2005/CodeSnippet">
    <CodeSnippet Format="1.0.0">
        <Header>
            <Title>${escapeXml(metadata.title) || 'Mi Snippet'}</Title>
            <Shortcut>${escapeXml(metadata.shortcut) || ''}</Shortcut>
            <Description>${escapeXml(metadata.description) || 'Descripción.'}</Description>
            <Author>${escapeXml(metadata.author) || 'Generado por IA'}</Author>
            <SnippetTypes>
                <SnippetType>${escapeXml(metadata.snippetType) || 'Expansion'}</SnippetType>
            </SnippetTypes>
        </Header>
        <Snippet>
            <Code Language="SQL"><![CDATA[${sqlCode}]]></Code>
        </Snippet>
    </CodeSnippet>
</CodeSnippets>`;
        }

        function escapeXml(unsafe) { return unsafe.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'})[c]); }
        
        function displayResult(sqlCode) {
            sqlOutput.textContent = sqlCode;
            outputContainer.classList.remove('hidden');
        }

        // --- Action Buttons ---
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(sqlOutput.textContent).then(() => {
                showFeedback('¡XML copiado!', 'success');
            }, () => {
                showFeedback('Error al copiar', 'error');
            });
        });
        
        downloadBtn.addEventListener('click', () => {
            const xmlContent = sqlOutput.textContent;
            if (!xmlContent) return;
            const blob = new Blob([xmlContent], { type: 'text/xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = (snippetTitle.value || 'snippet').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `${fileName}.snippet`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function showFeedback(message, type = 'info') {
            feedback.textContent = message;
            feedback.className = 'text-center font-medium h-4 transition-colors duration-300';
            if (type === 'success') feedback.classList.add('text-green-400');
            else if (type === 'error') feedback.classList.add('text-red-400');
            
            setTimeout(() => { feedback.textContent = ''; }, 4000);
        }
    </script>
</body>
</html>
