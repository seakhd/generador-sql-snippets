<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Snippets SQL Server (Solo Descarga)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar el fichero de esquema externo -->
    <script src="schema.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .code-block { font-family: 'Roboto Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader { animation: spin 1s linear infinite; }
        .form-input, .form-select, .form-textarea {
            background-color: #374151; border: 1px solid #4b5563; border-radius: 0.5rem;
            padding: 0.75rem; width: 100%; color: #e5e7eb; transition: all 0.2s ease-in-out;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none; box-shadow: 0 0 0 2px #2563eb; border-color: #2563eb;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Generador de Snippets SQL Server</h1>
            <p class="text-gray-400 mt-2">Crea y descarga snippets con el contexto de tu BBDD.</p>
        </div>

        <!-- Step 1: Metadata -->
        <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-semibold text-gray-300 mb-4">1. Metadatos del Snippet</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="snippet-title" class="block text-sm font-medium text-gray-400 mb-1">Título</label>
                    <input type="text" id="snippet-title" class="form-input" placeholder="Ej: Seleccionar Clientes Activos">
                </div>
                <div>
                    <label for="snippet-shortcut" class="block text-sm font-medium text-gray-400 mb-1">Atajo (Shortcut)</label>
                    <input type="text" id="snippet-shortcut" class="form-input" placeholder="Ej: selact">
                </div>
                <div class="md:col-span-2">
                    <label for="snippet-description" class="block text-sm font-medium text-gray-400 mb-1">Descripción</label>
                    <input type="text" id="snippet-description" class="form-input" placeholder="Ej: Devuelve todos los clientes con estado activo">
                </div>
                <div>
                    <label for="snippet-author" class="block text-sm font-medium text-gray-400 mb-1">Autor</label>
                    <input type="text" id="snippet-author" class="form-input" placeholder="Tu nombre o alias">
                </div>
                <div>
                    <label for="snippet-type" class="block text-sm font-medium text-gray-400 mb-1">Tipo de Snippet</label>
                    <select id="snippet-type" class="form-select">
                        <option>Expansion</option>
                        <option>SurroundsWith</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Step 2: Snippet Content -->
         <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-semibold text-gray-300 mb-4">2. Contenido del Snippet</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label for="plain-text-input" class="block text-sm font-medium text-gray-400">Escribe tu consulta:</label>
                    <textarea id="plain-text-input" rows="8" class="form-textarea h-full" placeholder="Ej: 'Selecciona los 5 clientes más recientes'"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-400">O sube un archivo .SQL:</label>
                    <div id="file-drop-area" class="flex flex-col items-center justify-center w-full h-full border-2 border-dashed border-gray-600 rounded-lg p-4 cursor-pointer hover:bg-gray-700/50 hover:border-cyan-500 transition">
                        <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <p id="file-info" class="mb-2 text-sm text-gray-400 text-center"><span class="font-semibold">Haz clic para subir</span> o arrastra</p>
                        <input type="file" id="sql-file-input" class="hidden" accept=".sql">
                    </div>
                     <button id="clear-file-btn" class="hidden w-full mt-2 text-sm text-red-400 hover:text-red-300">Quitar archivo</button>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center pt-4">
            <button id="generate-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center mx-auto disabled:bg-gray-500 disabled:cursor-not-allowed">
                <svg id="loader" class="loader w-5 h-5 mr-3 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.75V6.25m0 11.5v1.5m8.25-8.25H18M4.25 12H6m12.55-6.34l-1.06 1.06M7.81 16.19l-1.06 1.06M17.25 6.75l-1.06-1.06M7.81 7.81l-1.06-1.06" /></svg>
                <span id="generate-btn-text">Generar Snippet</span>
            </button>
        </div>

        <!-- Output Section -->
        <div id="output-container" class="hidden space-y-4 pt-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h2 class="text-xl font-semibold text-gray-300">3. Resultado (.snippet XML)</h2>
                <div class="flex gap-2">
                    <button id="copy-btn" class="bg-gray-600 hover:bg-gray-500 text-gray-200 font-semibold py-2 px-4 rounded-lg flex items-center">
                        Copiar
                    </button>
                    <button id="download-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Descargar Fichero
                    </button>
                </div>
            </div>
            <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700">
                <pre class="p-4 overflow-x-auto"><code id="sql-output" class="code-block text-cyan-300"></code></pre>
            </div>
            <div id="feedback" class="text-center font-medium h-4"></div>
        </div>
    </div>

    <script>
        // DOM Elements
        const plainTextInput = document.getElementById('plain-text-input');
        const sqlFileInput = document.getElementById('sql-file-input');
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInfo = document.getElementById('file-info');
        const clearFileBtn = document.getElementById('clear-file-btn');
        const generateBtn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const generateBtnText = document.getElementById('generate-btn-text');
        const outputContainer = document.getElementById('output-container');
        const sqlOutput = document.getElementById('sql-output');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');
        const feedback = document.getElementById('feedback');
        
        // Metadata inputs
        const snippetTitle = document.getElementById('snippet-title');
        const snippetShortcut = document.getElementById('snippet-shortcut');
        const snippetDescription = document.getElementById('snippet-description');
        const snippetAuthor = document.getElementById('snippet-author');
        const snippetType = document.getElementById('snippet-type');

        let fileContent = null;
        let fileName = '';

        // --- File Handling ---
        fileDropArea.addEventListener('click', () => sqlFileInput.click());
        sqlFileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('bg-gray-700/50', 'border-cyan-500'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, () => fileDropArea.classList.remove('bg-gray-700/50', 'border-cyan-500'), false);
        });
        fileDropArea.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.sql')) {
                handleFile(file);
            } else {
                alert('Por favor, sube solo archivos .sql');
            }
        });

        function handleFile(file) {
            fileName = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                fileContent = e.target.result;
                fileInfo.textContent = `Archivo: ${fileName}`;
                fileInfo.classList.add('text-cyan-400', 'font-bold');
                clearFileBtn.classList.remove('hidden');
                plainTextInput.disabled = true;
                plainTextInput.value = '';
                plainTextInput.placeholder = 'La entrada de texto está deshabilitada.';
            };
            reader.readAsText(file);
        }
        
        clearFileBtn.addEventListener('click', () => {
            fileContent = null;
            fileName = '';
            sqlFileInput.value = '';
            fileInfo.innerHTML = `<span class="font-semibold">Haz clic para subir</span> o arrastra`;
            fileInfo.classList.remove('text-cyan-400', 'font-bold');
            clearFileBtn.classList.add('hidden');
            plainTextInput.disabled = false;
            plainTextInput.placeholder = "Ej: 'Selecciona los 5 clientes más recientes'";
        });

        // --- Generation Logic ---
        generateBtn.addEventListener('click', async () => {
            if (typeof PRELOADED_SCHEMA === 'undefined') {
                alert('Error: El fichero schema.js no se ha cargado correctamente. Asegúrate de que el fichero existe en la misma carpeta que el HTML.');
                return;
            }

            const inputText = plainTextInput.value.trim();
            const userInput = fileContent || inputText;

            if (!userInput) {
                alert('Por favor, escribe una consulta o sube un archivo .SQL.');
                return;
            }
            if (!snippetTitle.value) {
                alert('Por favor, introduce un título para el snippet.');
                snippetTitle.focus();
                return;
            }
            
            setLoading(true);

            try {
                const prompt = `
                    Eres un experto en SQL Server. Tu tarea es convertir la siguiente petición de un usuario en un snippet de código T-SQL (SQL Server) que sea limpio, optimizado y bien formateado.
                    Contexto del Esquema de la Base de Datos (MUY IMPORTANTE): Usa OBLIGATORIAMENTE el siguiente esquema para asegurarte de que los nombres de tablas y columnas son correctos.
                    ---
                    ${PRELOADED_SCHEMA}
                    ---
                    Petición del Usuario:
                    ---
                    ${userInput}
                    ---
                    Reglas de Salida:
                    1. El resultado DEBE ser sintácticamente correcto para SQL Server y basarse en el esquema proporcionado.
                    2. Formato: Usa indentación clara y mayúsculas para las palabras clave de SQL (SELECT, FROM, etc.).
                    3. Respuesta: Devuelve ÚNICAMENTE el bloque de código SQL, sin explicaciones ni texto introductorio.
                `;

                const apiKey = "AIzaSyB8kBhhLzqalW8aSvxLvGCuXueogQqRPYo"; // Managed by the execution environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Error en la API: ${response.statusText}`);

                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    let generatedSql = result.candidates[0].content.parts[0].text;
                    generatedSql = generatedSql.replace(/^```sql\n?/, '').replace(/```$/, '').trim();
                    
                    const metadata = {
                        title: snippetTitle.value,
                        shortcut: snippetShortcut.value,
                        description: snippetDescription.value,
                        author: snippetAuthor.value,
                        snippetType: snippetType.value
                    };
                    
                    const xmlSnippet = createSnippetXML(metadata, generatedSql);
                    displayResult(xmlSnippet);
                } else {
                    displayResult("<!-- No se pudo generar el snippet. Por favor, intenta de nuevo. -->");
                }

            } catch (error) {
                console.error('Error:', error);
                displayResult(`<!-- Ocurrió un error: ${error.message} -->`);
            } finally {
                setLoading(false);
            }
        });
        
        function createSnippetXML(metadata, sqlCode) {
            const safeSqlCode = sqlCode.replace(/]]>/g, ']]]]><![CDATA[>');
            return `<?xml version="1.0" encoding="utf-8" ?>
<CodeSnippets xmlns="http://schemas.microsoft.com/VisualStudio/2005/CodeSnippet">
    <CodeSnippet Format="1.0.0">
        <Header>
            <Title>${escapeXml(metadata.title) || 'Mi Snippet'}</Title>
            <Shortcut>${escapeXml(metadata.shortcut) || ''}</Shortcut>
            <Description>${escapeXml(metadata.description) || 'Descripción.'}</Description>
            <Author>${escapeXml(metadata.author) || 'Generado por IA'}</Author>
            <SnippetTypes>
                <SnippetType>${escapeXml(metadata.snippetType) || 'Expansion'}</SnippetType>
            </SnippetTypes>
        </Header>
        <Snippet>
            <Code Language="SQL"><![CDATA[${safeSqlCode}]]></Code>
        </Snippet>
    </CodeSnippet>
</CodeSnippets>`;
        }

        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'})[c]);
        }
        
        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            loader.classList.toggle('hidden', !isLoading);
            generateBtnText.textContent = isLoading ? 'Generando...' : 'Generar Snippet';
        }

        function displayResult(sqlCode) {
            sqlOutput.textContent = sqlCode;
            outputContainer.classList.remove('hidden');
        }

        // --- Action Buttons ---
        copyBtn.addEventListener('click', () => {
            const textToCopy = sqlOutput.textContent;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showFeedback('¡XML copiado al portapapeles!', 'success');
            } catch (err) {
                showFeedback('Error al copiar', 'error');
            }
            document.body.removeChild(textArea);
        });
        
        downloadBtn.addEventListener('click', () => {
            const xmlContent = sqlOutput.textContent;
            if (!xmlContent) return;

            const blob = new Blob([xmlContent], { type: 'text/xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = (snippetTitle.value || 'snippet').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `${fileName}.snippet`;
            document.body.appendChild(a);
a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function showFeedback(message, type = 'info') {
            feedback.textContent = message;
            feedback.className = 'text-center font-medium h-4'; // Reset classes
            if (type === 'success') feedback.classList.add('text-green-400');
            else if (type === 'error') feedback.classList.add('text-red-400');
            
            setTimeout(() => { feedback.textContent = ''; }, 4000);
        }
    </script>
</body>
</html>

